

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% CIRCUITIKZ - TRIODE WITH FILAMENT
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Triode keys
%%
\ctikzset{tubes/width/.initial=1}                           % relative width
\ctikzset{tubes/height/.initial=1}                          % relative height

\ctikzset{tubes/triode/tube radius/.initial=0.40}           % radius of tube circle
\ctikzset{tubes/triode/anode distance/.initial=0.30}        % distance from grid
\ctikzset{tubes/triode/anode width/.initial=0.40}           % width of an anode/plate
\ctikzset{tubes/triode/cathode distance/.initial=0.30}      % distance from grid
\ctikzset{tubes/triode/cathode width/.initial=0.40}         % width of an cathode
\ctikzset{tubes/triode/cathode corners/.initial=0.06}       % corners of the cathode wire
\ctikzset{tubes/triode/cathode right extend/.initial=0.075} % extension at the right side
\ctikzset{tubes/triode/grid protrusion/.initial=0.25}       % distance from center
\ctikzset{tubes/triode/grid dashes/.initial=5}              % number of grid dashes
\ctikzset{tubes/triode/filament distance/.initial=0.1}     	% distance from cathode
\ctikzset{tubes/triode/filament angle/.initial=15}          % Angle from centerpoint


%%
%% Tube filament behaves like a sort of style
%%
\makeatletter
\newif\ifpgf@circuit@tubes@filament
\pgfkeys{/tikz/filament/.add code={}{\pgf@circuit@tubes@filamenttrue}}
\ctikzset{tubes/triode/filament/.add code={}{\pgf@circuit@tubes@filamenttrue}}
\makeatother

%%
%% This is the Circuitikz element for a triode filament.
%% Basic anchors: grid, anode, cathode, text
%%
\makeatletter

% Draw tube
\def\pgf@circ@tubes@drawtube{%
			\pgfmathparse{(\pgf@circ@res@up-\pgf@circ@res@right)}
			\pgfpathmoveto{\pgfpoint{-\pgf@circ@res@right}{0pt}}
			\@tempdima=\pgfmathresult pt
			\pgfpathlineto{\pgfpoint{-\pgf@circ@res@right}{\@tempdima}}
			\pgfpatharc{180}{0}{\pgf@circ@res@right}
			\pgfpathlineto{\pgfpoint{\pgf@circ@res@right}{-\@tempdima}}
			\pgfpatharc{180}{0}{-\pgf@circ@res@right}
			\pgfpathclose
}

\pgfdeclareshape{triode}{
    \anchor{center}{
        \pgfpointorigin
    }
    \savedanchor\northwest{%
		\pgf@circ@res@up=\ctikzvalof{tubes/height}\pgf@circ@Rlen
		\pgf@circ@res@right=\ctikzvalof{tubes/width}\pgf@circ@Rlen
		% x and y should be half the Rlen
        \pgf@y=\pgf@circ@res@up
        \pgf@y=.5\pgf@y
        \pgf@x=-\pgf@circ@res@right
        \pgf@x=.5\pgf@x
    }
	\anchor{north} {%
		\northwest
		\pgf@x=0pt
	}
    \anchor{east}{%
        \northwest
        \pgf@x=-\pgf@x
        \pgf@y=0pt
    }
	\anchor{south}{%
        \northwest
        \pgf@y=-\pgf@y
		\pgf@x=0pt
	}
    \anchor{west}{%
        \northwest
        \pgf@y=0pt
    }
    \anchor{north west}{%
        \northwest
    }
    \anchor{north east}{%
        \northwest
        \pgf@x=-\pgf@x
    }
    \anchor{south east}{
        \northwest
        \pgf@x=-\pgf@x
        \pgf@y=-\pgf@y
    }
    \anchor{south west}{
        \northwest
        \pgf@y=-\pgf@y
    }
	\anchor{anode} {%
		\northwest
		\pgf@x=0pt
	}
    \anchor{grid}{%
        \northwest
        \pgf@y=0pt
    }
	\anchor{cathode}{%
        \northwest
        \pgf@y=-\pgf@y
		\pgf@x=\ctikzvalof{tubes/triode/cathode width}\pgf@x
	}
    \anchor{text}{%
        \northwest
        \pgf@x=-\pgf@x
        \pgf@y=0pt
    }
	\backgroundpath{
		\pgfscope
			% Line width for tripoles
			\pgfsetlinewidth{\ctikzvalof{tripoles/thickness}\pgflinewidth}

			% Setup to draw tube
			\pgf@circ@res@up=\ctikzvalof{tubes/height}\pgf@circ@Rlen
			\pgf@circ@res@right=\ctikzvalof{tubes/width}\pgf@circ@Rlen
			\pgf@circ@res@up=\ctikzvalof{tubes/triode/tube radius}\pgf@circ@res@up
			\pgf@circ@res@right=\ctikzvalof{tubes/triode/tube radius}\pgf@circ@res@right

			% Tube fill color (if any)
			\ifx\tikz@fillcolor\pgfutil@empty
			\else
				\pgfscope
					\pgfsetfillcolor{\tikz@fillcolor}
					\pgf@circ@tubes@drawtube
					\pgfusepath{fill}
				\endpgfscope
    		\fi

			% Tube
			\pgf@circ@tubes@drawtube

			% Setup to draw filament, anode and cathode
			\pgf@circ@res@up=\ctikzvalof{tubes/height}\pgf@circ@Rlen
			\pgf@circ@res@right=\ctikzvalof{tubes/width}\pgf@circ@Rlen
			\pgf@circ@res@up=0.5\pgf@circ@res@up
			\pgf@circ@res@right=0.5\pgf@circ@res@right

			% Grid protrusion
			\pgfpathmoveto{\pgfpoint{-\pgf@circ@res@right}{0pt}}
			\pgfmathqparse{-\ctikzvalof{tubes/triode/tube radius}\pgf@circ@res@right-\ctikzvalof{tubes/triode/grid protrusion}\pgf@circ@res@right}
			\pgf@xa=\pgfmathresult pt
			\pgfpathlineto{\pgfpoint{\pgf@xa}{0pt}}

			% Grid dashes: calculations
			\pgf@xb=2\pgf@circ@res@right
			\pgf@circ@res@step=\ctikzvalof{tubes/triode/tube radius}\pgf@xb
			\@tempcnta=\ctikzvalof{tubes/triode/grid dashes}  % dashes*2+1
			\multiply\@tempcnta by 2\relax
			\advance\@tempcnta by 1\relax
			\advance\pgf@circ@res@step by -\pgf@xa
			\divide\pgf@circ@res@step by \@tempcnta
			% Grid dashes: draw
			\pgf@circ@res@temp=\pgf@xa
			\@tempcnta=\ctikzvalof{tubes/triode/grid dashes}  % dashes
			\loop
				\advance\pgf@circ@res@temp by\pgf@circ@res@step
				\pgfpathmoveto{\pgfpoint{\pgf@circ@res@temp}{0pt}}
				\advance\pgf@circ@res@temp by\pgf@circ@res@step
				\pgfpathlineto{\pgfpoint{\pgf@circ@res@temp}{0pt}}
				\advance\@tempcnta by-1
				\ifnum\@tempcnta>0\relax
			\repeat

			% Filament (is not drawn by default)
			\ifpgf@circuit@tubes@filament
				\pgf@circ@res@temp=-\ctikzvalof{tubes/triode/cathode distance}\pgf@circ@res@up
				\advance\pgf@circ@res@temp by -\ctikzvalof{tubes/triode/filament distance}\pgf@circ@res@up
				\pgfmathparse{(\ctikzvalof{tubes/triode/tube radius}*sin(\ctikzvalof{tubes/triode/filament angle})}
				\pgf@xa=\pgfmathresult\pgf@circ@res@right
				\pgfmathparse{\ctikzvalof{tubes/triode/tube radius}+\ctikzvalof{tubes/triode/tube radius}*cos(\ctikzvalof{tubes/triode/filament angle}}
				\pgf@ya=\pgfmathresult\pgf@circ@res@up
				\pgfpathmoveto{\pgfpoint{0pt}{\pgf@circ@res@temp}}
				\pgfpathlineto{\pgfpoint{-\pgf@xa}{-\pgf@ya}}
				\pgfpathlineto{\pgfpoint{-\pgf@xa}{-\pgf@circ@res@up}}
				\pgfpathmoveto{\pgfpoint{0pt}{\pgf@circ@res@temp}}
				\pgfpathlineto{\pgfpoint{\pgf@xa}{-\pgf@ya}}
				\pgfpathlineto{\pgfpoint{\pgf@xa}{-\pgf@circ@res@up}}
				\pgf@circuit@tubes@filamentfalse
			\fi

			% Anode (or plate)
			\pgfpathmoveto{\pgfpoint{0pt}{\pgf@circ@res@up}} % north
			\pgfpathlineto{\pgfpoint{0pt}{\ctikzvalof{tubes/triode/anode distance}\pgf@circ@res@up}}
			\pgfpathmoveto{\pgfpoint{-\ctikzvalof{tubes/triode/anode width}\pgf@circ@res@right}{\ctikzvalof{tubes/triode/anode distance}\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\ctikzvalof{tubes/triode/anode width}\pgf@circ@res@right}{\ctikzvalof{tubes/triode/anode distance}\pgf@circ@res@up}}

			% Cathode
			\pgfsetcornersarced{\pgfpoint{\ctikzvalof{tubes/triode/cathode corners}\pgf@circ@res@up}{\ctikzvalof{tubes/triode/cathode corners}\pgf@circ@res@up}}
			\pgfpathmoveto{\pgfpoint{-\ctikzvalof{tubes/triode/cathode width}\pgf@circ@res@right}{-\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{-\ctikzvalof{tubes/triode/cathode width}\pgf@circ@res@right}{-\ctikzvalof{tubes/triode/cathode distance}\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\ctikzvalof{tubes/triode/cathode width}\pgf@circ@res@right}{-\ctikzvalof{tubes/triode/cathode distance}\pgf@circ@res@up}}
			\pgfpathlineto{\pgfpoint{\ctikzvalof{tubes/triode/cathode width}\pgf@circ@res@right}{-\ctikzvalof{tubes/triode/cathode distance}\pgf@circ@res@up-\ctikzvalof{tubes/triode/cathode right extend}\pgf@circ@res@up}}
			\pgfusepath{draw}
			            
		\endpgfscope
	}
}
\makeatother
